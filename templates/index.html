<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t('title') }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .nav-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .nav-language {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-language::before {
            content: "ðŸŒ";
            font-size: 1em;
        }

        #languageSelect {
            padding: 4px 8px;
            border: 2px solid #007bff;
            border-radius: 4px;
            background-color: white;
            color: #007bff;
            font-weight: 600;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
            width: auto;
            min-width: 80px;
            max-width: 100px;
        }

        #languageSelect:hover {
            background-color: #007bff;
            color: white;
        }

        #languageSelect:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        .nav-menu-icon {
            font-size: 1.5em;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
            color: #495057;
            line-height: 1;
        }

        .nav-menu-icon:hover {
            background-color: #e9ecef;
        }

        /* Modal/Popup Styles */
        .nav-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.2s;
        }

        .nav-modal-overlay.active {
            display: flex;
            justify-content: flex-end;
            align-items: flex-start;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .nav-modal {
            background-color: white;
            width: 300px;
            max-width: 90vw;
            height: 100%;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s;
            overflow-y: auto;
        }

        .nav-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            background-color: #f8f9fa;
        }

        .nav-modal-title {
            font-weight: 600;
            font-size: 1.1em;
            color: #495057;
        }

        .nav-modal-close {
            font-size: 1.5em;
            cursor: pointer;
            color: #6c757d;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .nav-modal-close:hover {
            background-color: #e9ecef;
            color: #495057;
        }

        .nav-modal-content {
            padding: 20px;
        }

        .nav-modal-user {
            color: #495057;
            font-weight: 500;
            font-size: 1em;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .nav-modal-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-modal-links a {
            text-decoration: none;
            color: #007bff;
            font-weight: 500;
            padding: 10px 15px;
            border-radius: 4px;
            transition: background-color 0.2s;
            font-size: 0.95em;
            display: block;
        }

        .nav-modal-links a:hover {
            background-color: #e7f3ff;
            text-decoration: none;
        }

        .nav-collapsible {
            width: 100%;
            order: 4;
            margin-top: 10px;
            border-top: 1px solid #dee2e6;
            padding-top: 10px;
        }

        .nav-collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 8px 12px;
            background-color: #e9ecef;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.9em;
            color: #495057;
            transition: background-color 0.2s;
        }

        .nav-collapsible-header:hover {
            background-color: #dee2e6;
        }

        .nav-collapsible-icon {
            transition: transform 0.3s;
            font-size: 0.8em;
        }

        .nav-collapsible-header.active .nav-collapsible-icon {
            transform: rotate(180deg);
        }

        .nav-collapsible-content {
            display: none;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin-top: 8px;
        }

        .nav-collapsible-content.active {
            display: block;
        }

        .nav-collapsible-content > * {
            display: block;
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .nav-collapsible-content > *:last-child {
            margin-bottom: 0;
        }

        .nav-data-source-note {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .nav-station-links {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .nav-station-links a {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .nav-station-links a:hover {
            background-color: #e7f3ff;
            text-decoration: underline;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .nav-bar {
                padding: 10px 15px;
            }

            .nav-modal {
                width: 100%;
                max-width: 100vw;
            }

            .nav-collapsible {
                margin-top: 12px;
            }
        }
    </style>
</head>

<body>

    <div class="nav-bar">
        <div class="nav-language">
            <select id="languageSelect" onchange="window.location.href='/set_language/' + this.value">
                <option value="en" {% if lang()=='en' %}selected{% endif %}>English</option>
                <option value="zh" {% if lang()=='zh' %}selected{% endif %}>ä¸­æ–‡</option>
            </select>
        </div>

        <div class="nav-menu-icon" onclick="toggleNavModal()">â˜°</div>
    </div>

    <!-- Navigation Modal/Popup -->
    <div class="nav-modal-overlay" id="navModal" onclick="closeNavModal(event)">
        <div class="nav-modal" onclick="event.stopPropagation()">
            <div class="nav-modal-header">
                <div class="nav-modal-title">{{ t('nav.menu') }}</div>
                <button class="nav-modal-close" onclick="closeNavModal()">Ã—</button>
            </div>
            <div class="nav-modal-content">
                <div class="nav-modal-user">
                    {% if current_user.is_authenticated %}
                    {{ t('nav.welcome_user', username=current_user.username) }}
                    {% elif session.get('is_visitor_access') %}
                    {% if session.get('visitor_level') == 'advanced' %}{{ t('nav.welcome_advanced_visitor') }}{% else %}{{
                    t('nav.welcome_visitor') }}{% endif %}
                    {% else %}
                    {{ t('nav.welcome') }}!
                    {% endif %}
                </div>

                <div class="nav-modal-links">
                    {% if current_user.is_authenticated %}
                    {% if current_user.is_admin %}
                    <a href="/invitation">{{ t('nav.manage_invites') }}</a>
                    {% endif %}
                    <a href="/logout">{{ t('nav.logout') }}</a>
                    {% elif session.get('is_visitor_access') %}
                    <a href="/logout">{{ t('nav.exit_visitor_mode') }}</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

        <div class="nav-collapsible">
            <div class="nav-collapsible-header" onclick="toggleNavCollapsible()">
                <span>{{ t('params.data_source_info') }}</span>
                <span class="nav-collapsible-icon">â–¼</span>
            </div>
            <div class="nav-collapsible-content">
                <div class="nav-data-source-note">{{ t('params.data_source_note') }}</div>
                <div class="nav-station-links">
                    <a href="https://www.ncei.noaa.gov/pub/data/ghcn/daily/ghcnd-stations.txt" target="_blank"
                        rel="noopener">{{ t('links.ghcnd_stations_list') }}</a>
                    <a href="https://www.ncei.noaa.gov/pub/data/noaa/isd-history.txt" target="_blank" rel="noopener">{{ t('links.gsod_stations_list') }}</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleNavCollapsible() {
            const header = document.querySelector('.nav-collapsible-header');
            const content = document.querySelector('.nav-collapsible-content');
            header.classList.toggle('active');
            content.classList.toggle('active');
        }

        function toggleNavModal() {
            const modal = document.getElementById('navModal');
            modal.classList.toggle('active');
        }

        function closeNavModal(event) {
            if (event && event.target !== event.currentTarget) {
                return;
            }
            const modal = document.getElementById('navModal');
            modal.classList.remove('active');
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeNavModal();
            }
        });
    </script>

    <div class="container">
        <h1>{{ t('title') }}</h1>

        <!-- PART 1: PARAMETERS -->
        <div class="section">
            <h2>{{ t('sections.parameters') }}</h2>

            <div class="param-row">
                <label>{{ t('params.data_source') }}</label>
                <select id="dataSource" style="width: auto; max-width: 120px;">
                    <option value="GHCND" selected>GHCND</option>
                    <option value="GSOD">GSOD</option>
                </select>
            </div>

            <div class="param-row">
                <label>{{ t('params.station_search') }}</label>
                <input type="text" id="stationInput" list="stationOptions"
                    placeholder="{{ t('params.type_name_or_id') }}" oninput="searchStations()" autocomplete="off">
                <datalist id="stationOptions"></datalist>
                <input type="hidden" id="stationId" value="RSM00030565">
            </div>

            <div id="stationInfoDisplay" class="station-details"></div>

            <!-- COLLAPSIBLE SECTION 1: Date Restrict -->
            <div class="collapsible-wrapper" id="dateRestrictSection">
                <div class="collapsible-header" onclick="toggleSection('dateRestrictSection')">
                    <strong>{{ t('params.date_restrict') }}</strong>
                    <span class="collapsible-icon">â–¼</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-inner">
                        <div class="param-row">
                            <label>{{ t('params.date_range') }}</label>
                            <select id="quickDateRange" style="width: auto; max-width: 180px; margin-right: 10px;"
                                onchange="applyQuickDateRange()">
                                <option value="">{{ t('params.custom_all') }}</option>
                                <option value="1991-2020">1991 - 2020</option>
                                <option value="1961-1990">1961 - 1990</option>
                            </select>
                            <input type="date" id="startDate" value="1800-01-01">
                            <span>{{ t('params.to') }}</span>
                            <input type="date" id="endDate" value="2100-12-31">
                        </div>

                        <div class="param-row">
                            <label>{{ t('params.month_focus') }}</label>
                            <select id="monthFilter" onchange="updateDayDropdown()">
                                <option value="0">{{ t('months.full_year') }}</option>
                                <option value="winter_3">{{ t('months.winter_3') }}</option>
                                <option value="summer_3">{{ t('months.summer_3') }}</option>
                                <option value="1">{{ t('months.january') }}</option>
                                <option value="2">{{ t('months.february') }}</option>
                                <option value="3">{{ t('months.march') }}</option>
                                <option value="4">{{ t('months.april') }}</option>
                                <option value="5">{{ t('months.may') }}</option>
                                <option value="6">{{ t('months.june') }}</option>
                                <option value="7">{{ t('months.july') }}</option>
                                <option value="8">{{ t('months.august') }}</option>
                                <option value="9">{{ t('months.september') }}</option>
                                <option value="10">{{ t('months.october') }}</option>
                                <option value="11">{{ t('months.november') }}</option>
                                <option value="12">{{ t('months.december') }}</option>
                            </select>
                            <select id="dayFilter" style="display: none; margin-left: 10px; width: auto; max-width: 120px;">
                                <option value="0">{{ t('params.all_days') }}</option>
                            </select>
                        </div>

                        <div class="param-row">
                            <label>{{ t('params.hemisphere') }}</label>
                            <div class="radio-group">
                                <label style="font-weight: normal; width: auto;"><input type="radio" name="hemisphere"
                                        value="north" checked> {{ t('hemisphere.north') }}</label>
                                <label style="font-weight: normal; width: auto;"><input type="radio" name="hemisphere"
                                        value="south"> {{ t('hemisphere.south') }}</label>
                            </div>
                        </div>

                        <div class="param-row">
                            <label>{{ t('params.season_mode') }}</label>
                            <div class="radio-group">
                                <label style="font-weight: normal; width: auto;"><input type="radio" name="season"
                                        value="winter" checked> {{ t('season.winter') }}</label>
                                <label style="font-weight: normal; width: auto;"><input type="radio" name="season"
                                        value="summer"> {{
                                    t('season.summer') }}</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="divider"></div>

            <!-- COLLAPSIBLE SECTION 2: Temperature Threshold -->
            <div class="collapsible-wrapper" id="temperatureSection">
                <div class="collapsible-header" onclick="toggleSection('temperatureSection')">
                    <strong>{{ t('params.temperature_threshold') }}</strong>
                    <span class="collapsible-icon">â–¼</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-inner">
                        <p style="margin: 0 0 10px 0; font-size: 0.9em; color: #666;">{{
                            t('params.threshold_explanation') }}</p>
                        <div class="param-grid">
                            <div class="thresh-box">
                                <strong>{{ t('thresholds.tmin_threshold') }}</strong>
                                <select id="tminDir">
                                    <option value="lte">&le;</option>
                                    <option value="gte">&ge;</option>
                                </select>
                                <input type="number" id="tminVal" value="-50"
                                    placeholder="{{ t('thresholds.value_c') }}">
                            </div>
                            <div class="thresh-box">
                                <strong>{{ t('thresholds.tavg_threshold') }}</strong>
                                <select id="tavgDir">
                                    <option value="lte">&le;</option>
                                    <option value="gte">&ge;</option>
                                </select>
                                <input type="number" id="tavgVal" value="-40"
                                    placeholder="{{ t('thresholds.value_c') }}">
                            </div>
                            <div class="thresh-box">
                                <strong>{{ t('thresholds.tmax_threshold') }}</strong>
                                <select id="tmaxDir">
                                    <option value="lte">&le;</option>
                                    <option value="gte">&ge;</option>
                                </select>
                                <input type="number" id="tmaxVal" value="-30"
                                    placeholder="{{ t('thresholds.value_c') }}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLLAPSIBLE SECTION 3: Explosive Power -->
            <div class="collapsible-wrapper" id="explosivePowerSection">
                <div class="collapsible-header" onclick="toggleSection('explosivePowerSection')">
                    <strong>{{ t('params.explosive_power') }}</strong>
                    <span class="collapsible-icon">â–¼</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-inner">
                        <div class="param-grid">
                            <div class="thresh-box">
                                <strong>{{ t('thresholds.custom_average_base.tmin') }}</strong>
                                <label style="font-weight:normal; font-size:0.9em;">{{
                                    t('thresholds.for_tmin_explosive') }}</label>
                                <input type="number" id="customAvgTmin"
                                    placeholder="{{ t('thresholds.leave_blank_avg') }}">
                            </div>
                            <div class="thresh-box">
                                <strong>{{ t('thresholds.custom_average_base.tavg') }}</strong>
                                <label style="font-weight:normal; font-size:0.9em;">{{
                                    t('thresholds.for_tavg_explosive') }}</label>
                                <input type="number" id="customAvgTavg"
                                    placeholder="{{ t('thresholds.leave_blank_avg') }}">
                            </div>
                            <div class="thresh-box">
                                <strong>{{ t('thresholds.custom_average_base.tmax') }}</strong>
                                <label style="font-weight:normal; font-size:0.9em;">{{
                                    t('thresholds.for_tmax_explosive') }}</label>
                                <input type="number" id="customAvgTmax"
                                    placeholder="{{ t('thresholds.leave_blank_avg') }}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="divider"></div>

            <!-- MULTI STATION PARAMS (Only for Admin or Advanced) -->
            {% if (current_user.is_authenticated and (current_user.is_admin or current_user.user_level == 'advanced'))
            or (session.get('is_visitor_access') and session.get('visitor_level') == 'advanced') %}
            <!-- COLLAPSIBLE SECTION 4: Multiple Stations Search Conditions -->
            <div class="collapsible-wrapper" id="multiStationSection">
                <div class="collapsible-header" onclick="toggleSection('multiStationSection')">
                    <strong>{{ t('multi_station.search_conditions') }}</strong>
                    <span class="collapsible-icon">â–¼</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-inner">
                        <div id="multiParamsArea">
                            <div class="param-row">
                                <label>{{ t('multi_station.center_location_mode') }}</label>
                                <select id="centerMode" onchange="toggleCenterLocMode()">
                                    <option value="station">{{ t('multi_station.by_weather_station') }}</option>
                                    <option value="coords">{{ t('multi_station.by_coordinates') }}</option>
                                </select>
                            </div>

                            <div class="param-grid" id="coordsInputArea" style="display:none;">
                                <div class="thresh-box">
                                    <strong>{{ t('multi_station.center_latitude') }}</strong>
                                    <input type="number" id="centerLat"
                                        placeholder="{{ t('multi_station.decimal_deg') }}">
                                </div>
                                <div class="thresh-box">
                                    <strong>{{ t('multi_station.center_longitude') }}</strong>
                                    <input type="number" id="centerLon"
                                        placeholder="{{ t('multi_station.decimal_deg') }}">
                                </div>
                            </div>

                            <div class="param-row">
                                <label>{{ t('multi_station.max_distance_km') }}</label>
                                <select id="maxDist">
                                    <option value="no_limit">{{ t('multi_station.no_limit') }}</option>
                                    <option value="50">50</option>
                                    <option value="200">200</option>
                                    <option value="500">500</option>
                                    <option value="2000">2000</option>
                                </select>
                            </div>

                            <div class="param-row">
                                <label>{{ t('multi_station.country_limit') }}</label>
                                <input type="text" id="countryLimit"
                                    placeholder="{{ t('multi_station.country_example') }}">
                            </div>

                            <div class="param-grid">
                                <div class="thresh-box">
                                    <strong>{{ t('multi_station.latitude_range') }}</strong>
                                    <input type="number" id="latMin" placeholder="{{ t('multi_station.min') }}">
                                    <input type="number" id="latMax" placeholder="{{ t('multi_station.max') }}">
                                </div>
                                <div class="thresh-box">
                                    <strong>{{ t('multi_station.longitude_range') }}</strong>
                                    <input type="number" id="lonMin" placeholder="{{ t('multi_station.min') }}">
                                    <input type="number" id="lonMax" placeholder="{{ t('multi_station.max') }}">
                                </div>
                                <div class="thresh-box">
                                    <strong>{{ t('multi_station.elevation_range') }}</strong>
                                    <input type="number" id="elevMin" placeholder="{{ t('multi_station.min') }}">
                                    <input type="number" id="elevMax" placeholder="{{ t('multi_station.max') }}">
                                </div>
                            </div>

                            <div class="param-row" id="wbanRow" style="display:none;">
                                <label>{{ t('multi_station.wban_limit') }}</label>
                                <div class="radio-group">
                                    <label style="font-weight: normal; width: auto;"><input type="radio"
                                            name="wbanLimit" value="no" checked> {{ t('multi_station.no_limit')
                                        }}</label>
                                    <label style="font-weight: normal; width: auto;"><input type="radio"
                                            name="wbanLimit" value="99999"> {{ t('multi_station.limit_to_99999')
                                        }}</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="divider"></div>
            {% endif %}

            <button class="submit-btn" onclick="fetchData()">{{ t('params.get_data') }}</button>

            <div id="loading" class="hidden">{{ t('params.loading_data') }}</div>
            <div id="errorMsg" class="error"></div>
        </div>

        <!-- PART 2: STATISTICS -->
        <div class="section">
            <h2>{{ t('sections.global_statistics') }}</h2>
            <div class="table-responsive">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>{{ t('tables.type') }}</th>
                            <th>{{ t('tables.min_c') }}</th>
                            <th>{{ t('tables.avg_c') }}</th>
                            <th>{{ t('tables.max_c') }}</th>
                            <th>{{ t('tables.explosive_power') }}</th>
                            <th>{{ t('tables.days_matching_threshold') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>{{ t('statistics.label_tmin_min') }}</strong></td>
                            <td id="stat-tmin-min">-</td>
                            <td id="stat-tmin-avg">-</td>
                            <td id="stat-tmin-max">-</td>
                            <td id="stat-tmin-power">-</td>
                            <td id="stat-tmin-count">-</td>
                        </tr>
                        <tr>
                            <td><strong>{{ t('statistics.label_tavg_min') }}</strong></td>
                            <td id="stat-tavg-min">-</td>
                            <td id="stat-tavg-avg">-</td>
                            <td id="stat-tavg-max">-</td>
                            <td id="stat-tavg-power">-</td>
                            <td id="stat-tavg-count">-</td>
                        </tr>
                        <tr>
                            <td><strong>{{ t('statistics.label_tmax_min') }}</strong></td>
                            <td id="stat-tmax-min">-</td>
                            <td id="stat-tmax-avg">-</td>
                            <td id="stat-tmax-max">-</td>
                            <td id="stat-tmax-power">-</td>
                            <td id="stat-tmax-count">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2>{{ t('sections.period_averages') }}</h2>
            <div class="table-responsive">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>{{ t('tables.avg_min_tmin_period') }}<br><span class="header-note">{{
                                    t('tables.val_used_total') }}</span></th>
                            <th>{{ t('tables.avg_min_tmax_period') }}<br><span class="header-note">{{
                                    t('tables.val_used_total') }}</span></th>
                            <th>{{ t('tables.avg_max_tmin_period') }}<br><span class="header-note">{{
                                    t('tables.val_used_total') }}</span></th>
                            <th>{{ t('tables.avg_max_tmax_period') }}<br><span class="header-note">{{
                                    t('tables.val_used_total') }}</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="sum-avg-min-tmin" class="summary-cell">-</td>
                            <td id="sum-avg-min-tmax" class="summary-cell">-</td>
                            <td id="sum-avg-max-tmin" class="summary-cell">-</td>
                            <td id="sum-avg-max-tmax" class="summary-cell">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2>{{ t('sections.period_details') }}</h2>

            <div style="max-height: 400px; overflow-y: auto;">
                <div class="table-responsive">
                    <table class="stats-table" id="periodStatsTable">
                        <thead>
                            <tr>
                                <th onclick="sortPeriodTable('range')">{{ t('tables.period_range') }} &#8645;</th>
                                <th onclick="sortPeriodTable('count_actual')">{{ t('tables.data_coverage') }} &#8645;
                                </th>
                                <th id="th_min_tmin" onclick="sortPeriodTable('min_tmin')">{{ t('tables.min_tmin') }}
                                    &#8645;</th>
                                <th id="th_min_tmax" onclick="sortPeriodTable('min_tmax')">{{ t('tables.min_tmax') }}
                                    &#8645;</th>
                                <th id="th_max_tmin" onclick="sortPeriodTable('max_tmin')">{{ t('tables.max_tmin') }}
                                    &#8645;</th>
                                <th id="th_max_tmax" onclick="sortPeriodTable('max_tmax')">{{ t('tables.max_tmax') }}
                                    &#8645;</th>
                                <th onclick="sortPeriodTable('cnt_tmin')">{{ t('tables.days_tmin') }} &#8645;</th>
                                <th onclick="sortPeriodTable('cnt_tavg')">{{ t('tables.days_tavg') }} &#8645;</th>
                                <th onclick="sortPeriodTable('cnt_tmax')">{{ t('tables.days_tmax') }} &#8645;</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PART 3: RECORD LIST -->
        <div class="section">
            <h2>{{ t('sections.record_list') }}</h2>

            <div class="record-controls">
                <!-- REMOVED Filter Elements -->
                <div class="control-group">
                    <span style="font-weight:bold;">{{ t('tables.max_records') }}</span>
                    <select id="recordLimitSelect" style="width:auto; padding:5px;">
                        <option value="5" selected>5</option>
                        <option value="50">50</option>
                        <option value="200">200</option>
                    </select>
                    <button class="small-btn" onclick="updateRecordsList()">{{ t('tables.update_records') }}</button>
                </div>
            </div>
            <div id="sortingLoading" class="hidden" style="color: #e67e22; font-weight: bold; margin-bottom: 10px;">
                {{ t('tables.fetching_records') }}
            </div>
            <div class="table-responsive">
                <table class="data-table" id="recordsTable">
                    <thead>
                        <tr>
                            <th onclick="triggerServerSort('DATE')">{{ t('tables.date') }} &#8645;</th>
                            <th onclick="triggerServerSort('TMIN')">{{ t('statistics.label_tmin_min') }} (â„ƒ) &#8645;
                            </th>
                            <th onclick="triggerServerSort('TAVG')">{{ t('statistics.label_tavg_min') }} (â„ƒ) &#8645;
                            </th>
                            <th onclick="triggerServerSort('TMAX')">{{ t('statistics.label_tmax_min') }} (â„ƒ) &#8645;
                            </th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- PART 4 & 5 (Restricted) -->
        {% if (current_user.is_authenticated and (current_user.is_admin or current_user.user_level == 'advanced')) or
        (session.get('is_visitor_access') and session.get('visitor_level') == 'advanced') %}

        <!-- PART 4: MULTIPLE STATIONS -->
        <div class="section">
            <h2>{{ t('sections.multiple_stations') }}</h2>

            <div class="record-controls">
                <div class="control-group">
                    <span style="font-weight:bold;">{{ t('tables.max_stations') }}</span>
                    <select id="multiLimitSelect" style="width:auto; padding:5px;">
                        <option value="5" selected>5</option>
                        <option value="50">50</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                        <option value="1000">1000</option>
                    </select>
                </div>
                <div class="control-group">
                    <button class="small-btn" onclick="updateMultiStations()">{{ t('tables.update_list') }}</button>
                    <button class="small-btn" style="background-color: #17a2b8;" onclick="copyMultiTable()">{{
                        t('tables.copy_table_tsv') }}</button>
                </div>
            </div>

            <div id="multiStationLoading" class="hidden"
                style="color: #e67e22; font-weight: bold; margin-bottom: 10px;">
                {{ t('tables.updating_station_list') }}
            </div>

            <div class="table-responsive">
                <table class="data-table" id="multiStationTable">
                    <thead>
                        <tr>
                            <th onclick="triggerMultiSort('id')">{{ t('tables.id') }} &#8645;</th>
                            <th onclick="triggerMultiSort('name')">{{ t('tables.name') }} &#8645;</th>
                            <th onclick="triggerMultiSort('lat')">{{ t('tables.latitude') }} &#8645;</th>
                            <th onclick="triggerMultiSort('lon')">{{ t('tables.longitude') }} &#8645;</th>
                            <th onclick="triggerMultiSort('elev')">{{ t('tables.elevation_m') }} &#8645;</th>
                            <th onclick="triggerMultiSort('dist')">{{ t('tables.distance_km') }} &#8645;</th>
                            <th onclick="triggerMultiSort('country')">{{ t('tables.country') }} &#8645;</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- PART 5: MULTIPLE STATIONS STATISTICS -->
        <div class="section">
            <h2>{{ t('sections.multiple_stats') }}</h2>

            <div class="record-controls">
                <div class="control-group" style="flex:1;">
                    <span style="font-weight:bold;">{{ t('tables.select_statistic') }}</span>
                    <select id="multiStatSelect" style="width:auto; max-width:250px; padding:5px;">
                        <option value="avg_tmin">{{ t('statistics.average_tmin') }}</option>
                        <option value="avg_tavg">{{ t('statistics.average_tavg') }}</option>
                        <option value="avg_tmax">{{ t('statistics.average_tmax') }}</option>
                        <option value="min_tmin">{{ t('statistics.minimum_tmin') }}</option>
                        <option value="min_tavg">{{ t('statistics.minimum_tavg') }}</option>
                        <option value="min_tmax">{{ t('statistics.minimum_tmax') }}</option>
                        <option value="max_tmin">{{ t('statistics.maximum_tmin') }}</option>
                        <option value="max_tavg">{{ t('statistics.maximum_tavg') }}</option>
                        <option value="max_tmax">{{ t('statistics.maximum_tmax') }}</option>
                        <option value="max_days_tmin">{{ t('statistics.max_days_tmin') }}</option>
                        <option value="max_days_tavg">{{ t('statistics.max_days_tavg') }}</option>
                        <option value="max_days_tmax">{{ t('statistics.max_days_tmax') }}</option>
                    </select>
                </div>
                <div class="control-group">
                    <button class="small-btn" onclick="calcMultiStats()">{{ t('tables.calculate_stats') }}</button>
                    <button class="small-btn" style="background-color: #17a2b8;" onclick="copyMultiStatsTable()">{{
                        t('tables.copy_table_tsv') }}</button>
                </div>
            </div>

            <div id="multiStatLoading" class="hidden" style="color: #e67e22; font-weight: bold; margin-bottom: 10px;">
                {{ t('tables.calculating_statistics') }}
            </div>

            <div class="table-responsive">
                <table class="data-table" id="multiStatResultTable">
                    <thead>
                        <tr>
                            <th onclick="sortMultiStatTable('id')">{{ t('tables.station_id') }} &#8645;</th>
                            <th onclick="sortMultiStatTable('name')">{{ t('tables.station_name') }} &#8645;</th>
                            <th onclick="sortMultiStatTable('dist')">{{ t('tables.distance_km') }} &#8645;</th>
                            <th onclick="sortMultiStatTable('val')">{{ t('tables.value') }} &#8645;</th>
                            <th>{{ t('tables.relevant_dates_periods') }}</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <div id="copyToast">{{ t('messages.copied_to_clipboard') }}</div>

        <!-- PERIOD SELECTION MODAL -->
        <div id="periodModal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3>{{ t('modal.select_period') }}</h3>
                <div id="periodList" class="period-list"></div>
                <button onclick="document.getElementById('periodModal').classList.add('hidden')"
                    style="margin-top:15px; width:100%; padding:8px;">{{ t('modal.close') }}</button>
            </div>
        </div>

    </div>
    <script>
        // Pass translation to JavaScript
        const STATION_INFO_TITLE = "{{ t('params.current_selected_station') }}";
    </script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>

</html>